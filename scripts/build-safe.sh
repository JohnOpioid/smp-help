#!/bin/bash
# –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–±–æ—Ä–∫–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ –∏ —Ç–∞–π–º–∞—É—Ç–∞–º–∏

set -e  # –ü—Ä–µ—Ä—ã–≤–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É –ø—Ä–æ–µ–∫—Ç–∞..."

# –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç –ø–∞–º—è—Ç–∏
export NODE_OPTIONS="--max-old-space-size=4096"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç (30 –º–∏–Ω—É—Ç)
TIMEOUT=1800

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–∏
cleanup() {
    echo "‚ö†Ô∏è  –°–±–æ—Ä–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞. –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã..."
    rm -rf .nuxt
    rm -rf .output
    exit 1
}

trap cleanup SIGINT SIGTERM

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—É—é –ø–∞–º—è—Ç—å
echo "üíæ –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—É—é –ø–∞–º—è—Ç—å..."
FREE_MEM=$(free -m | awk 'NR==2{printf "%.0f", $4}')
echo "–î–æ—Å—Ç—É–ø–Ω–æ –ø–∞–º—è—Ç–∏: ${FREE_MEM}MB"

if [ "$FREE_MEM" -lt 2048 ]; then
    echo "‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ: –¥–æ—Å—Ç—É–ø–Ω–æ –º–µ–Ω–µ–µ 2GB –ø–∞–º—è—Ç–∏. –°–±–æ—Ä–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ–π."
fi

# –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–±–æ—Ä–∫–∏
echo "üßπ –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–±–æ—Ä–∫–∏..."
rm -rf .nuxt
rm -rf .output

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É —Å —Ç–∞–π–º–∞—É—Ç–æ–º
echo "üî® –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É (—Ç–∞–π–º–∞—É—Ç: ${TIMEOUT} —Å–µ–∫—É–Ω–¥)..."
if timeout $TIMEOUT npm run build:production; then
    echo "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
    exit 0
else
    EXIT_CODE=$?
    if [ $EXIT_CODE -eq 124 ]; then
        echo "‚ùå –°–±–æ—Ä–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞ –ø–æ —Ç–∞–π–º–∞—É—Ç—É (${TIMEOUT} —Å–µ–∫—É–Ω–¥)"
    else
        echo "‚ùå –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π (–∫–æ–¥: $EXIT_CODE)"
    fi
    cleanup
fi

