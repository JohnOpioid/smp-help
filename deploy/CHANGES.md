# Изменения в скрипте установки

## Версия 2.0 - 2025-10-12

### Основные изменения

#### 1. Убрана автоматическая установка MongoDB
- **Было:** Скрипт автоматически устанавливал MongoDB 8.0
- **Стало:** Скрипт проверяет наличие установленного MongoDB и работает с существующей установкой
- **Причина:** На сервере уже установлен MongoDB, нет необходимости переустанавливать

#### 2. Добавлен ввод пароля MongoDB
- **Было:** Пароль генерировался автоматически и создавался новый пользователь
- **Стало:** Скрипт запрашивает существующие учётные данные MongoDB (пользователь и пароль)
- **Опция:** Если пароль не указан, генерируется автоматически (для новых установок)

#### 3. Исправлено экранирование JWT_SECRET
- **Было:** JWT_SECRET подставлялся напрямую в heredoc, что могло вызывать переносы строк
- **Стало:** Используется система плейсхолдеров с последующей заменой через `sed`
- **Результат:** JWT_SECRET всегда остаётся в одной строке, ошибки синтаксиса исключены

#### 4. Изменена функция setup_mongodb → check_mongodb
- **Было:** `setup_mongodb()` создавала пользователя MongoDB
- **Стало:** `check_mongodb()` проверяет подключение с указанными учётными данными
- **Функционал:** Проверяет, что MongoDB запущен и доступен, предупреждает если учётные данные неверны

### Процесс установки теперь:

```
1. Проверка системных требований
2. Ввод параметров проекта (GitHub, домен и т.д.)
3. Ввод учётных данных MongoDB (название БД, пользователь, пароль)
4. Установка зависимостей (Node.js, Nginx, PM2)
5. Проверка MongoDB (а не установка/создание пользователя)
6. Клонирование и сборка проекта
7. Настройка PM2 с правильным экранированием
8. Настройка Nginx, Firewall
9. Проверка статуса
```

### Преимущества

✅ **Безопасность:**
- JWT_SECRET корректно экранируется, нет переносов строк
- Используются существующие учётные данные MongoDB
- Не создаются лишние пользователи в БД

✅ **Совместимость:**
- Работает с уже установленным MongoDB
- Не перезаписывает существующую конфигурацию MongoDB
- Поддерживает различные версии MongoDB

✅ **Надёжность:**
- Проверка подключения к MongoDB перед развёртыванием
- Предупреждения о неверных учётных данных
- Меньше точек отказа

### Использование

#### Для новой установки:

```bash
./interactive-deploy.sh
# Выберите: 1) Чистая установка
# Введите данные MongoDB, которые уже существуют в системе
```

#### Если нужно создать пользователя MongoDB:

Используйте отдельный скрипт:

```bash
./create-mongodb-user.sh
```

Этот скрипт:
- Временно отключает авторизацию MongoDB
- Создаёт пользователя с указанным паролем
- Включает авторизацию обратно
- Проверяет подключение

### Миграция со старой версии

Если вы использовали старую версию скрипта:

1. Узнайте пароль MongoDB из конфигурации:
```bash
cat /home/smp-help/smp-help/ecosystem.config.cjs | grep MONGODB_URI
```

2. Запишите учётные данные

3. При следующем обновлении используйте эти учётные данные

### Совместимость

- ✅ Ubuntu 20.04+
- ✅ Debian 11+
- ✅ MongoDB 6.0+, 7.0, 8.0
- ✅ Node.js 20+

### Известные проблемы

Если пользователь MongoDB не существует, скрипт предупредит об этом, но продолжит установку. Приложение не сможет подключиться к БД. Решение:

```bash
# Используйте скрипт создания пользователя
./create-mongodb-user.sh

# Или создайте вручную
mongosh
use smp-help;
db.createUser({
  user: 'help-smp-user',
  pwd: 'ваш-пароль',
  roles: ['readWrite']
});
```

### Откат изменений

Если нужно вернуться к старому поведению (автоматическая установка MongoDB):

```bash
git checkout HEAD~1 deploy/interactive-deploy.sh
```

Или используйте версию из коммита до изменений.

### Дополнительные скрипты

Вместе с обновлением добавлены вспомогательные скрипты:

- `create-mongodb-user.sh` - Создание пользователя MongoDB
- `fix-mongodb-password.sh` - Изменение пароля MongoDB
- `diagnose-site.sh` - Диагностика проблем с сайтом

### Вопросы и поддержка

При возникновении проблем:

1. Проверьте, что MongoDB установлен: `mongosh --version`
2. Проверьте, что MongoDB запущен: `systemctl status mongod`
3. Проверьте подключение: `mongosh "mongodb://user:pass@localhost:27017/db"`
4. Используйте скрипты диагностики

### История версий

- **v2.0** (2025-10-12): Убрана установка MongoDB, исправлено экранирование JWT
- **v1.0** (2025-10-11): Первая версия с автоматической установкой MongoDB

